$('form.new_message').on('ajax:success', function(){
  $(this).find("#message_content").val("");
});
$(function(){
  if ($('.messages').size() > 0) {

    var pusher = new Pusher('<%= Pusher.key %>');

    var pusher_connection_status = "initialized";
    pusher.connection.bind('connected', function() {
      if (pusher_connection_status == "disconnected") {
        location.reload();
      }
      pusher_connection_status = "connected";
    });
    pusher.connection.bind('disconnected', function() {
      pusher_connection_status = "disconnected";
    });
    pusher.connection.bind('unavailable', function() {
      pusher_connection_status = "disconnected";
    });

    var channel = pusher.subscribe($('.messages').data('channel'));
    channel.bind('pusher:subscription_succeeded', function(members) {
      members.each(function(member) {
        add_member(member.id, member.info);
      });
    });
    channel.bind('pusher:member_added', function(member) {
      add_member(member.id, member.info);
    });
    channel.bind('pusher:member_removed', function(member) {
      remove_member(member.id, member.info);
    });
    channel.bind('message_added', function(data) {
      var $message = $('<li><span class="time"> ' + data.time +
        ' </span><span class="username' +
        ($('#my_name').text() == data.message.user_name ? ' myself' : '') +
        '"> (' + data.message.user_name + ') </span><span class="content"> ' +
         data.message.content + ' </span></li>').hide();
      $('ul.messages').prepend($message);
      $message.fadeIn();
    });

    $.each(['#f00', '#ff0', '#0f0', '#0ff', '#00f', '#f0f', '#000', '#fff'], function() {
      $('#tools').append("<a href='#graffiti' data-color='" + this + "' style='width: 10px; background: " + this + ";'></a> ");
    });
    $.each([3, 5, 10, 15], function() {
      $('#tools').append("<a href='#graffiti' data-size='" + this + "' style='background: #ccc'>" + this + "</a> ");
    });
    $('#graffiti').sketch();

  }
});

function add_member(member_id, member_info) {
  var $member = $('<li>' + member_info.name + '</li>');
  if ($('#my_name').text() == member_info.name) {
    $member.addClass('myself');
  }
  var $members = $('.members');
  $members.append($member);
  var $members_li = $members.find('li');
  $members.html($members_li.sort(function(a,b) {
    return $(a).text() < $(b).text() ? -1 : 1;
  }));
}
function remove_member(member_id, member_info) {
  var $members = $('.members li');
  $members.each(function() {
    var $member = $(this);
    if ($member.text() == member_info.name) {
      $member.remove();
    }
  });
}
