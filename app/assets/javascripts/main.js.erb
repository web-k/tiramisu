$('form.new_message').on('ajax:success', function(){
  $(this).find("#message_content").val("");
});
$(function(){
  if ($('.messages').size() > 0) {

    var pusher = new Pusher('<%= Pusher.key %>');

    var pusher_connection_status = "initialized";
    pusher.connection.bind('connected', function() {
      if (pusher_connection_status == "disconnected") {
        location.reload();
      }
      pusher_connection_status = "connected";
    });
    pusher.connection.bind('disconnected', function() {
      pusher_connection_status = "disconnected";
    });
    pusher.connection.bind('unavailable', function() {
      pusher_connection_status = "disconnected";
    });

    var channel = pusher.subscribe($('.messages').data('channel'));
    channel.bind('pusher:subscription_succeeded', function(members) {
      members.each(function(member) {
        add_member(member.id, member.info);
      });
    });
    channel.bind('pusher:member_added', function(member) {
      add_member(member.id, member.info);
    });
    channel.bind('pusher:member_removed', function(member) {
      remove_member(member.id, member.info);
    });
    channel.bind('message_added', function(data) {
      var $message = $('<li><span class="time"> ' + data.time +
        ' </span><span class="username' +
        ($('#my_name').text() == data.message.user_name ? ' myself' : '') +
        '"> (' + data.message.user_name + ') </span><span class="content"> ' +
         data.message.content + ' </span></li>').hide();
      $('ul.messages').prepend($message);
      $message.fadeIn();
      if ($('#my_name').text() != data.message.user_name) {
        webkit_notifications(data.message.user_name, data.message.content);
      }
    });
  }
  check_webkit_notifications();
});

function check_webkit_notifications() {
  if(typeof window.webkitNotifications == 'undefined'){return;}
  var permission = webkitNotifications.checkPermission();
  if (permission != 0) {
    var $button = $('<input type="button" class="btn btn-small" value="デスクトップへの通知を許可" id="webkit_notifications_button">');
    $('p.logout').append($button);

    $('#webkit_notifications_button').bind('click', function(e){
      webkitNotifications.requestPermission();
    });
  }
}

function webkit_notifications(user_name, content) {
  if(typeof window.webkitNotifications == 'undefined'){return;}
  var permission = webkitNotifications.checkPermission();
  switch(permission){
    case 0:
      var notification = webkitNotifications.createNotification('', user_name, content);
      var notification_display_time = 10* 1000;
      notification.ondisplay = function(){
        setTimeout(function(){
          notification.cancel();
        }, notification_display_time);
      };
      notification.show();
      break;
    case 1:
      webkitNotifications.requestPermission();
      break;
    case 2:
      break;
  }
}

function add_member(member_id, member_info) {
  var $member = $('<li>' + member_info.name + '</li>');
  if ($('#my_name').text() == member_info.name) {
    $member.addClass('myself');
  }
  var $members = $('.members');
  $members.append($member);
  var $members_li = $members.find('li');
  $members.html($members_li.sort(function(a,b) {
    return $(a).text() < $(b).text() ? -1 : 1;
  }));
}
function remove_member(member_id, member_info) {
  var $members = $('.members li');
  $members.each(function() {
    var $member = $(this);
    if ($member.text() == member_info.name) {
      $member.remove();
    }
  });
}
